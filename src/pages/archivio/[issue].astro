---
import { getCollection } from 'astro:content';
import Header from '../../components/Header.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getMegaclusterForArticle, getLabels } from '../../config/taxonomy.js';
import numeriData from '../../../scripts_and_data/datasets/numeri_rivista/numeri_wp_FINAL.json';
import megacluster from '../../data/articoli_megacluster.json';

const byId = (megacluster as { byId?: Record<string, { img_copertina_url?: string }> }).byId || {};

// Genera tutti i percorsi statici
export async function getStaticPaths() {
  const numeri = numeriData as Array<{
    id_numero: string;
    tipo_rivista: string;
    numero_progressivo: number;
    anno_pubblicazione: number;
    [key: string]: any;
  }>;

  // Ordina numeri per anno e numero progressivo
  const numeriOrdinati = [...numeri].sort((a, b) => {
    if (a.anno_pubblicazione !== b.anno_pubblicazione) {
      return a.anno_pubblicazione - b.anno_pubblicazione;
    }
    return a.numero_progressivo - b.numero_progressivo;
  });

  return numeriOrdinati.map((numero, index) => {
    // Genera slug dal id_numero (es. "INS-10" -> "ins-10")
    const slug = numero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-');
    
    // Trova numero precedente e successivo
    const prevNumero = index > 0 ? numeriOrdinati[index - 1] : null;
    const nextNumero = index < numeriOrdinati.length - 1 ? numeriOrdinati[index + 1] : null;
    
    const prevSlug = prevNumero ? prevNumero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-') : null;
    const nextSlug = nextNumero ? nextNumero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-') : null;
    
    return {
      params: { issue: slug },
      props: { 
        numero,
        prevSlug,
        nextSlug,
        prevTitle: prevNumero?.display_title || prevNumero?.titolo_numero || null,
        nextTitle: nextNumero?.display_title || nextNumero?.titolo_numero || null,
      },
    };
  });
}

const { numero, prevSlug, nextSlug, prevTitle, nextTitle } = Astro.props;

// Carica tutti gli articoli
const allArticles = await getCollection('blog');

// Filtra articoli per questo numero
// Match usando issue_number (preferito) o numero_rivista + anno_rivista
const articoliNumero = allArticles.filter(article => {
  // Metodo 1: Usa issue_number se presente
  const issueNumber = article.data.issue_number;
  if (issueNumber === numero.id_numero) {
    return true;
  }
  
  // Metodo 2: Fallback su numero_rivista + anno_rivista
  const artNumero = article.data.numero_rivista;
  const artAnno = article.data.anno_rivista;
  
  const matches = artNumero === numero.numero_progressivo && 
                  artAnno === numero.anno_pubblicazione;
  
  return matches;
});

// Debug logging durante la build con dettagli
const articoliConNumero = allArticles.filter(a => a.data.numero_rivista !== undefined && a.data.numero_rivista !== null).length;
const articoliConAnno = allArticles.filter(a => a.data.anno_rivista !== undefined && a.data.anno_rivista !== null).length;
const articoliUrlCount = numero.articoli_urls?.length || 0;

console.log(`[ARCHIVIO DEBUG] Numero ${numero.id_numero} (n.${numero.numero_progressivo}, ${numero.anno_pubblicazione}):`);
console.log(`  - Articoli trovati con match: ${articoliNumero.length}`);
console.log(`  - Articoli URL nel JSON: ${articoliUrlCount}`);
console.log(`  - Totale articoli con numero_rivista: ${articoliConNumero}`);
console.log(`  - Totale articoli con anno_rivista: ${articoliConAnno}`);

// Determina URL per sfogliare online (Archive.org)
const archiveViewUrl = numero.archive_view_url || null;

// Determina URL per scaricare PDF
const pdfUrl = numero.archive_download_pdf_url || numero.pdf_url || null;

// Determina testata
const testata = numero.tipo_rivista === 'insieme' ? 'Insieme' : 'Ombre e Luci';

// Descrizione/sommario
const descrizione = numero.seo_description || numero.descrizione_ai || numero.descrizione_originale || null;

// Funzione per generare slug autore
function generateAuthorSlug(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}

// Funzione per formattare la data in italiano
function formatDateItalian(date: Date): string {
  return new Intl.DateTimeFormat('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{numero.display_title || numero.titolo_numero} - Archivio Ombre e Luci</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
        line-height: 1.75;
        color: #1a1a1a;
        background: #fafafa;
      }

      .issue-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      /* Hero Section */
      .hero-section {
        display: grid;
        grid-template-columns: 380px 1fr;
        gap: 3rem;
        margin-bottom: 4rem;
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .hero-cover {
        width: 100%;
        max-width: 380px;
      }

      .hero-cover img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .hero-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .hero-badge {
        display: inline-block;
        background: rgba(0, 0, 0, 0.05);
        color: #666;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 400;
        letter-spacing: 0.5px;
        width: fit-content;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-title {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1.2;
        color: #1a1a1a;
        margin: 0;
      }

      .hero-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        font-size: 1.125rem;
        color: #666;
      }

      .hero-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .hero-meta-label {
        font-weight: 600;
        color: #333;
      }

      .hero-description {
        font-size: 1rem;
        line-height: 1.7;
        color: #555;
        margin-top: 0.5rem;
      }

      .hero-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .hero-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        background: #ff1053;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        text-transform: none;
        transition: all 0.3s ease-in-out;
        border: none;
        cursor: pointer;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-button:hover {
        background: #e00e4a;
        transform: translateY(-2px);
      }

      .hero-button.secondary {
        background: transparent;
        color: #ff1053;
        border: 1px solid #ff1053;
      }

      .hero-button.secondary:hover {
        background: #ff1053;
        color: white;
      }

      .hero-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      /* Navigazione Numeri */
      .issue-navigation {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 3rem;
        background: #fff;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .nav-link {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        text-decoration: none;
        color: #333;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .nav-link.prev {
        justify-content: flex-start;
      }

      .nav-link.next {
        justify-content: flex-end;
        text-align: right;
      }

      .nav-link:hover {
        background: transparent;
        color: #ff1053;
        border: 1px solid #ff1053;
      }

      .nav-link.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
      }

      .nav-arrow {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ff1053;
      }

      .nav-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .nav-label {
        font-size: 0.875rem;
        color: #666;
        letter-spacing: 0.5px;
      }

      .nav-title {
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.3;
      }

      /* Articoli Section */
      .articles-section {
        margin-top: 3rem;
      }

      .articles-header {
        margin-bottom: 2rem;
      }

      .articles-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
      }

      .articles-count {
        font-size: 1rem;
        color: #666;
      }

      .articles-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 32px;
      }

      .no-articles {
        text-align: center;
        padding: 4rem 2rem;
        color: #666;
        background: #fff;
        border-radius: 8px;
      }

      .no-articles-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: #333;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .hero-section {
          grid-template-columns: 1fr;
          gap: 2rem;
        }

        .hero-cover {
          max-width: 100%;
          margin: 0 auto;
        }

        .articles-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 32px;
        }
      }

      @media (max-width: 768px) {
        .issue-container {
          padding: 1.5rem 1rem;
        }

        .hero-section {
          padding: 1.5rem;
        }

        .hero-title {
          font-size: 2rem;
        }

        .hero-actions {
          flex-direction: column;
        }

        .hero-button {
          width: 100%;
          justify-content: center;
        }

        .articles-grid {
          grid-template-columns: 1fr;
          gap: 32px;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    
    <div class="issue-container">
      {/* Hero Section */}
      <section class="hero-section">
        <div class="hero-cover">
          {numero.copertina_url ? (
            <img 
              src={numero.copertina_url} 
              alt={`Copertina ${testata} n. ${numero.numero_progressivo}`}
              loading="eager"
            />
          ) : (
            <div style="width: 100%; aspect-ratio: 3/4; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 2rem;">
              <span style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">{testata}</span>
              <span style="font-size: 1rem;">n. {numero.numero_progressivo}</span>
            </div>
          )}
        </div>

        <div class="hero-content">
          <span class="hero-badge">{testata}</span>
          
          <h1 class="hero-title">
            {numero.titolo_numero || numero.display_title}
          </h1>

          <div class="hero-meta">
            <div class="hero-meta-item">
              <span class="hero-meta-label">Numero:</span>
              <span>n. {numero.numero_progressivo}</span>
            </div>
            <div class="hero-meta-item">
              <span class="hero-meta-label">Anno:</span>
              <span>{numero.anno_pubblicazione}</span>
            </div>
            {numero.periodo_label && (
              <div class="hero-meta-item">
                <span class="hero-meta-label">Periodo:</span>
                <span>{numero.periodo_label}</span>
              </div>
            )}
          </div>

          {descrizione && (
            <div class="hero-description">
              {descrizione}
            </div>
          )}

          <div class="hero-actions">
            {archiveViewUrl ? (
              <a 
                href={archiveViewUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button"
              >
                <span>üìñ</span>
                <span>Sfoglia Online</span>
              </a>
            ) : (
              <button class="hero-button" disabled>
                <span>üìñ</span>
                <span>Sfoglia Online (non disponibile)</span>
              </button>
            )}

            {pdfUrl ? (
              <a 
                href={pdfUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button secondary"
              >
                <span>üì•</span>
                <span>Scarica PDF</span>
              </a>
            ) : (
              <button class="hero-button secondary" disabled>
                <span>üì•</span>
                <span>Scarica PDF (non disponibile)</span>
              </button>
            )}
          </div>
        </div>
      </section>

      {/* Navigazione Numeri */}
      {(prevSlug || nextSlug) && (
        <nav class="issue-navigation">
          {prevSlug ? (
            <a href={`/archivio/${prevSlug}`} class="nav-link prev">
              <span class="nav-arrow">‚Üê</span>
              <div class="nav-content">
                <span class="nav-label">Precedente</span>
                <span class="nav-title">{prevTitle}</span>
              </div>
            </a>
          ) : (
            <div class="nav-link prev disabled"></div>
          )}
          
          {nextSlug ? (
            <a href={`/archivio/${nextSlug}`} class="nav-link next">
              <div class="nav-content">
                <span class="nav-label">Successivo</span>
                <span class="nav-title">{nextTitle}</span>
              </div>
              <span class="nav-arrow">‚Üí</span>
            </a>
          ) : (
            <div class="nav-link next disabled"></div>
          )}
        </nav>
      )}

      {/* Articoli Section */}
      <section class="articles-section">
        <div class="articles-header">
          <h2 class="articles-title">Articoli in questo numero</h2>
          <p class="articles-count">
            {articoliNumero.length} {articoliNumero.length === 1 ? 'articolo' : 'articoli'}
          </p>
        </div>

        {articoliNumero.length > 0 ? (
          <div style="display: grid !important; grid-template-columns: 1fr 1fr 1fr !important; gap: 32px !important; align-items: start !important;">
            {articoliNumero.map(article => {
              const articleSlug = article.data.slug || article.slug;
              const articleDate = article.data.date instanceof Date 
                ? article.data.date 
                : new Date(article.data.date);
              const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
              const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
              const wpIdStr = String(article.data.wp_id ?? '');
              const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image;
              return (
                <div>
                  <ArticleCard
                    title={article.data.title}
                    slug={articleSlug}
                    categoriaMenu={categoria_menu ?? undefined}
                    issue={article.data.issue_number}
                    forma={formal}
                    author={article.data.author}
                    date={articleDate}
                    image={articleImage}
                  />
                </div>
              );
            })}
          </div>
        ) : (
          <div class="no-articles">
            <h3 class="no-articles-title">Nessun articolo trovato</h3>
            <p>Non sono stati trovati articoli associati a questo numero.</p>
          </div>
        )}
      </section>
    </div>
  </body>
</html>

