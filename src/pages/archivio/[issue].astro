---
import { getCollection } from 'astro:content';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import IssueNavPill from '../../components/IssueNavPill.astro';
import { ViewTransitions } from 'astro:transitions';
import '../../styles/global.css';
import { getMegaclusterForArticle, getLabels } from '../../config/taxonomy.js';
import numeriData from '../../data/numeri_consolidati.json';
import megacluster from '../../data/articoli_megacluster.json';

const byId = (megacluster as { byId?: Record<string, { img_copertina_url?: string }> }).byId || {};

// Genera tutti i percorsi statici
export async function getStaticPaths() {
  const numeri = numeriData as Array<{
    id_numero: string;
    tipo_rivista: string;
    numero_progressivo: number;
    anno_pubblicazione: number;
    [key: string]: any;
  }>;

  // Ordina numeri per anno e numero progressivo (anno null = numeri sintetici, ordinati per numero)
  const numeriOrdinati = [...numeri].sort((a, b) => {
    const annoA = a.anno_pubblicazione ?? 0;
    const annoB = b.anno_pubblicazione ?? 0;
    if (annoA !== annoB) return annoA - annoB;
    return (a.numero_progressivo ?? 0) - (b.numero_progressivo ?? 0);
  });

  return numeriOrdinati.map((numero, index) => {
    // Genera slug dal id_numero (es. "INS-10" -> "ins-10")
    const slug = numero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-');
    
    // Trova numero precedente e successivo
    const prevNumero = index > 0 ? numeriOrdinati[index - 1] : null;
    const nextNumero = index < numeriOrdinati.length - 1 ? numeriOrdinati[index + 1] : null;
    
    const prevSlug = prevNumero ? prevNumero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-') : null;
    const nextSlug = nextNumero ? nextNumero.id_numero.toLowerCase().replace(/[^a-z0-9-]/g, '-') : null;
    
    return {
      params: { issue: slug },
      props: { numero, prevSlug, nextSlug },
    };
  });
}

const { numero, prevSlug, nextSlug } = Astro.props;

// Carica tutti gli articoli
const allArticles = await getCollection('blog');

// Filtra articoli per questo numero
// Match usando issue_number (preferito) o numero_rivista + anno_rivista
const articoliNumero = allArticles.filter(article => {
  // Metodo 1: Usa issue_number se presente
  const issueNumber = article.data.issue_number;
  if (issueNumber === numero.id_numero) {
    return true;
  }
  
  // Metodo 2: Fallback su numero_rivista + anno_rivista
  const artNumero = article.data.numero_rivista;
  const artAnno = article.data.anno_rivista;
  
  const matches = artNumero === numero.numero_progressivo && 
                  artAnno === numero.anno_pubblicazione;
  
  return matches;
});

// Debug logging durante la build con dettagli
const articoliConNumero = allArticles.filter(a => a.data.numero_rivista !== undefined && a.data.numero_rivista !== null).length;
const articoliConAnno = allArticles.filter(a => a.data.anno_rivista !== undefined && a.data.anno_rivista !== null).length;
const articoliUrlCount = numero.articoli_urls?.length || 0;

console.log(`[ARCHIVIO DEBUG] Numero ${numero.id_numero} (n.${numero.numero_progressivo}, ${numero.anno_pubblicazione}):`);
console.log(`  - Articoli trovati con match: ${articoliNumero.length}`);
console.log(`  - Articoli URL nel JSON: ${articoliUrlCount}`);
console.log(`  - Totale articoli con numero_rivista: ${articoliConNumero}`);
console.log(`  - Totale articoli con anno_rivista: ${articoliConAnno}`);

// Determina URL per sfogliare online (Archive.org)
const archiveViewUrl = numero.archive_view_url || null;

// Determina URL per scaricare PDF
const pdfUrl = numero.archive_download_pdf_url || numero.pdf_url || null;

// Determina testata
const testata = numero.tipo_rivista === 'insieme' ? 'Insieme' : 'Ombre e Luci';

// Descrizione/sommario
const descrizione = numero.seo_description || numero.descrizione_ai || numero.descrizione_originale || null;

// Funzione per generare slug autore
function generateAuthorSlug(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}

// Funzione per formattare la data in italiano
function formatDateItalian(date: Date): string {
  return new Intl.DateTimeFormat('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

// Articoli in italiano (flusso principale) e in inglese (sezione separata in fondo)
const articoliIt = articoliNumero.filter(a => a.data.lang !== 'en');
const articoliEn = articoliNumero.filter(a => a.data.lang === 'en');
---

<html lang="it">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{numero.display_title || numero.titolo_numero} - Archivio Ombre e Luci</title>
    <ViewTransitions />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
        font-size: 18px;
        line-height: 1.7;
        color: var(--text-color, #2d2d2d);
        background: var(--bg-light, #f5f5f3);
      }

      /* Main sopra il footer (fixed) cosÃ¬ il contenuto non viene coperto */
      .issue-main {
        position: relative;
        z-index: 2;
        background: var(--bg-light, #f5f5f3);
      }

      .issue-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      /* Hero Section */
      .hero-section {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2.5rem;
        margin-bottom: 3rem;
        background: var(--bg-card, #fdfcfb);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border-color, #e8e6e3);
      }

      .hero-cover {
        width: 100%;
        max-width: 380px;
      }

      .hero-cover img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .hero-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .hero-badge {
        display: inline-block;
        background: rgba(0, 0, 0, 0.05);
        color: #666;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 400;
        letter-spacing: 0.5px;
        width: fit-content;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-title {
        font-size: clamp(1.75rem, 4vw, 2.5rem);
        font-weight: 700;
        line-height: 1.25;
        color: var(--text-color, #2d2d2d);
        margin: 0;
      }

      .hero-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        font-size: 1.125rem;
        color: #666;
      }

      .hero-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .hero-meta-label {
        font-weight: 600;
        color: #333;
      }

      .hero-description {
        font-size: 1rem;
        line-height: 1.7;
        color: #555;
        margin-top: 0.5rem;
      }

      .hero-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .hero-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        background: var(--accent-color, #c41e3a);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        text-transform: none;
        transition: all 0.3s ease-in-out;
        border: none;
        cursor: pointer;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-button:hover {
        background: var(--accent-hover, #a01930);
        transform: translateY(-2px);
      }

      .hero-button.secondary {
        background: transparent;
        color: var(--accent-color, #c41e3a);
        border: 1px solid var(--accent-color, #c41e3a);
      }

      .hero-button.secondary:hover {
        background: var(--accent-color, #c41e3a);
        color: white;
      }

      .hero-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      /* English Edition: sezione separata in fondo */
      .english-edition-section {
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color, #e8e6e3);
      }
      .english-edition-section h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary, #5c5c5c);
        margin-bottom: 1rem;
      }

      /* Articoli Section */
      .articles-section {
        margin-top: 2rem;
      }
      .articles-header {
        margin-bottom: 1.5rem;
      }
      .articles-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color, #2d2d2d);
        margin-bottom: 0.5rem;
      }
      .articles-count {
        font-size: 0.9375rem;
        color: var(--text-secondary, #5c5c5c);
      }
      .articles-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
      }
      .no-articles {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-secondary, #5c5c5c);
        background: var(--bg-card, #fdfcfb);
        border-radius: 8px;
        border: 1px solid var(--border-color, #e8e6e3);
      }

      .no-articles-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-color, #2d2d2d);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .hero-section {
          grid-template-columns: 1fr;
          gap: 2rem;
        }

        .hero-cover {
          max-width: 100%;
          margin: 0 auto;
        }

        .articles-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 32px;
        }
      }

      @media (max-width: 768px) {
        .issue-container {
          padding: 1.5rem 1.25rem;
        }

        .hero-section {
          padding: 1.5rem;
        }

        .hero-title {
          font-size: 2rem;
        }

        .hero-actions {
          flex-direction: column;
        }

        .hero-button {
          width: 100%;
          justify-content: center;
        }

        .articles-grid {
          grid-template-columns: 1fr;
          gap: 32px;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main class="issue-main">
    <div class="issue-container">
      {/* Hero Section */}
      <section class="hero-section">
        <div class="hero-cover">
          {numero.copertina_url ? (
            <img 
              src={numero.copertina_url} 
              alt={`Copertina ${testata} n. ${numero.numero_progressivo}`}
              loading="eager"
            />
          ) : (
            <div style="width: 100%; aspect-ratio: 3/4; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 2rem;">
              <span style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">{testata}</span>
              <span style="font-size: 1rem;">n. {numero.numero_progressivo}</span>
            </div>
          )}
        </div>

        <div class="hero-content">
          <span class="hero-badge">{testata}</span>
          
          <h1 class="hero-title">
            {numero.titolo_numero || numero.display_title}
          </h1>

          <div class="hero-meta">
            <div class="hero-meta-item">
              <span class="hero-meta-label">Numero:</span>
              <span>n. {numero.numero_progressivo}</span>
            </div>
            <div class="hero-meta-item">
              <span class="hero-meta-label">Anno:</span>
              <span>{numero.anno_pubblicazione}</span>
            </div>
            {numero.periodo_label && (
              <div class="hero-meta-item">
                <span class="hero-meta-label">Periodo:</span>
                <span>{numero.periodo_label}</span>
              </div>
            )}
          </div>

          {descrizione && (
            <div class="hero-description">
              {descrizione}
            </div>
          )}

          <div class="hero-actions">
            {archiveViewUrl ? (
              <a 
                href={archiveViewUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button"
              >
                <span>ðŸ“–</span>
                <span>Sfoglia Online</span>
              </a>
            ) : (
              <button class="hero-button" disabled>
                <span>ðŸ“–</span>
                <span>Sfoglia Online (non disponibile)</span>
              </button>
            )}

            {pdfUrl ? (
              <a 
                href={pdfUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button secondary"
              >
                <span>ðŸ“¥</span>
                <span>Scarica PDF</span>
              </a>
            ) : (
              <button class="hero-button secondary" disabled>
                <span>ðŸ“¥</span>
                <span>Scarica PDF (non disponibile)</span>
              </button>
            )}
          </div>
        </div>
      </section>

      {/* Articoli: lista uniforme (IT) + English Edition in fondo */}
      <section class="articles-section">
        <div class="articles-header">
          <h2 class="articles-title">Articoli in questo numero</h2>
          <p class="articles-count">
            {articoliIt.length} {articoliIt.length === 1 ? 'articolo' : 'articoli'}
            {articoliEn.length > 0 && ` Â· ${articoliEn.length} in English`}
          </p>
        </div>

        {articoliNumero.length > 0 ? (
          <>
            <div class="articles-grid">
              {articoliIt.map(article => {
                const articleSlug = article.data.slug || article.slug;
                const articleDate = article.data.date instanceof Date ? article.data.date : new Date(article.data.date);
                const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
                const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
                const wpIdStr = String(article.data.wp_id ?? '');
                const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image;
                return (
                  <ArticleCard
                    title={article.data.title}
                    slug={articleSlug}
                    categoriaMenu={categoria_menu ?? undefined}
                    issue={article.data.issue_number}
                    forma={formal}
                    author={article.data.author}
                    date={articleDate}
                    image={articleImage}
                  />
                );
              })}
            </div>

            {articoliEn.length > 0 && (
              <div class="english-edition-section">
                <h2>English Edition</h2>
                <div class="articles-grid">
                  {articoliEn.map(article => {
                    const articleSlug = article.data.slug || article.slug;
                    const articleDate = article.data.date instanceof Date ? article.data.date : new Date(article.data.date);
                    const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
                    const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
                    const wpIdStr = String(article.data.wp_id ?? '');
                    const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image;
                    return (
                      <ArticleCard
                        title={article.data.title}
                        slug={articleSlug}
                        categoriaMenu={categoria_menu ?? undefined}
                        issue={article.data.issue_number}
                        forma={formal}
                        author={article.data.author}
                        date={articleDate}
                        image={articleImage}
                      />
                    );
                  })}
                </div>
              </div>
            )}
          </>
        ) : (
          <div class="no-articles">
            <h3 class="no-articles-title">Nessun articolo trovato</h3>
            <p>Non sono stati trovati articoli associati a questo numero.</p>
          </div>
        )}
      </section>
    </div>
    </main>
    <Footer />
    <IssueNavPill prevSlug={prevSlug} nextSlug={nextSlug} />
  </body>
</html>

