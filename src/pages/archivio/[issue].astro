---
import { getCollection } from 'astro:content';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import IssueNavPill from '../../components/IssueNavPill.astro';
import { ViewTransitions } from 'astro:transitions';
import '../../styles/global.css';
import { getMegaclusterForArticle, getLabels } from '../../config/taxonomy.js';
import megacluster from '../../data/articoli_megacluster.json';

const byId = (megacluster as { byId?: Record<string, { img_copertina_url?: string }> }).byId || {};

// Genera tutti i percorsi statici dalla content collection numeri (stesso ordine sort_order asc per prev/next)
export async function getStaticPaths() {
  const rawNumeri = await getCollection('numeri');
  const numeriOrdinati = [...rawNumeri].sort((a, b) => {
    const orderA = a.data.sort_order ?? 0;
    const orderB = b.data.sort_order ?? 0;
    return orderA - orderB;
  });

  return numeriOrdinati.map((entry, index) => {
    const slug = entry.slug;
    const prevEntry = index > 0 ? numeriOrdinati[index - 1] : null;
    const nextEntry = index < numeriOrdinati.length - 1 ? numeriOrdinati[index + 1] : null;
    const prevSlug = prevEntry?.slug ?? null;
    const nextSlug = nextEntry?.slug ?? null;
    const numero = {
      ...entry.data,
      id: entry.data.id ?? entry.slug,
      id_numero: entry.data.id ?? entry.slug,
      tipo_rivista: entry.data.tipo === 'insieme' ? 'insieme' : 'ombre_e_luci',
      numero_progressivo: entry.data.numero ?? entry.data.numero_progressivo,
      anno_pubblicazione: entry.data.pubDate
        ? (typeof entry.data.pubDate === 'string' ? new Date(entry.data.pubDate) : entry.data.pubDate).getFullYear()
        : entry.data.anno_pubblicazione,
      titolo_numero: entry.data.title ?? entry.data.titolo_numero ?? entry.data.display_title,
      display_title: entry.data.display_title ?? entry.data.title ?? entry.data.titolo_numero,
      copertina_url: entry.data.copertina ?? entry.data.copertina_url,
      archive_view_url: entry.data.archive_view_url ?? entry.data.link_sfoglia,
      pdf_url: entry.data.link_pdf ?? entry.data.archive_download_pdf_url,
    };
    return {
      params: { issue: slug },
      props: { numero, prevSlug, nextSlug },
    };
  });
}

const { numero, prevSlug, nextSlug } = Astro.props;

const allArticles = await getCollection('blog');

// Articoli dal frontmatter del numero (array articoli = slug), ordinati per pubDate crescente (ordine indice)
function findArticleBySlug(slug: string) {
  return allArticles.find(
    (a) => a.slug === slug || a.slug.endsWith('/' + slug) || a.slug.split('/').pop() === slug
  );
}

const articoliSlugs = numero.articoli ?? [];
const articoliNumero = articoliSlugs
  .map((slug) => findArticleBySlug(slug))
  .filter((a): a is NonNullable<typeof a> => a != null)
  .sort((a, b) => {
    const dateA = a.data.date instanceof Date ? a.data.date : new Date(a.data.date);
    const dateB = b.data.date instanceof Date ? b.data.date : new Date(b.data.date);
    return dateA.getTime() - dateB.getTime();
  });

// Determina URL per sfogliare online (Archive.org)
const archiveViewUrl = numero.archive_view_url || null;

// Determina URL per scaricare PDF
const pdfUrl = numero.archive_download_pdf_url || numero.pdf_url || null;

// Determina testata
const testata = numero.tipo_rivista === 'insieme' ? 'Insieme' : 'Ombre e Luci';

// Descrizione/sommario
const descrizione = numero.seo_description || numero.descrizione_ai || numero.descrizione_originale || null;

// Funzione per generare slug autore
function generateAuthorSlug(name: string): string {
  return name
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '');
}

// Funzione per formattare la data in italiano
function formatDateItalian(date: Date): string {
  return new Intl.DateTimeFormat('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

// Articoli in italiano (flusso principale) e in inglese (sezione separata in fondo)
const articoliIt = articoliNumero.filter(a => a.data.lang !== 'en');
const articoliEn = articoliNumero.filter(a => a.data.lang === 'en');
---

<html lang="it">
  <head>
    <meta name="robots" content="noindex, nofollow" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{numero.display_title || numero.titolo_numero} - Archivio Ombre e Luci</title>
    <ViewTransitions />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
        font-size: 18px;
        line-height: 1.7;
        color: var(--text-color);
        background: var(--bg-light, #f5f5f3);
      }

      /* Main sopra il footer (fixed) cosÃ¬ il contenuto non viene coperto */
      .issue-main {
        position: relative;
        z-index: 2;
        background: var(--bg-light, #f5f5f3);
      }

      .issue-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem 1.5rem;
      }

      /* Hero Section */
      .hero-section {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2.5rem;
        margin-bottom: 3rem;
        background: var(--bg-card, #fdfcfb);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border-color, #e8e6e3);
      }

      .hero-cover {
        width: 100%;
        max-width: 380px;
      }

      .hero-cover img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .hero-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      .hero-badge {
        display: inline-block;
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 400;
        letter-spacing: 0.5px;
        width: fit-content;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-title {
        font-size: clamp(1.75rem, 4vw, 2.5rem);
        font-weight: 700;
        line-height: 1.25;
        color: var(--text-color);
        margin: 0;
      }

      .hero-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        font-size: 1.125rem;
        color: var(--text-secondary);
      }

      .hero-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .hero-meta-label {
        font-weight: 600;
        color: var(--text-color);
      }

      .hero-description {
        font-size: 1rem;
        line-height: 1.7;
        color: var(--text-secondary);
        margin-top: 0.5rem;
      }

      .hero-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }

      .hero-button {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.875rem 1.5rem;
        background: var(--accent-color);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        text-transform: none;
        transition: all 0.3s ease-in-out;
        border: none;
        cursor: pointer;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }

      .hero-button:hover {
        background: var(--accent-hover);
        transform: translateY(-2px);
      }

      .hero-button.secondary {
        background: transparent;
        color: var(--accent-color);
        border: 1px solid var(--accent-color);
      }

      .hero-button.secondary:hover {
        background: var(--accent-color);
        color: white;
      }

      .hero-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      /* English Edition: sezione separata in fondo */
      .english-edition-section {
        margin-top: 2.5rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color, #e8e6e3);
      }
      .english-edition-section h2 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-secondary, #5c5c5c);
        margin-bottom: 1rem;
      }

      /* Articoli Section */
      .articles-section {
        margin-top: 2rem;
      }
      .articles-header {
        margin-bottom: 1.5rem;
      }
      .articles-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 0.5rem;
      }
      .articles-count {
        font-size: 0.9375rem;
        color: var(--text-secondary, #5c5c5c);
      }
      .articles-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
      }
      .no-articles {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--text-secondary, #5c5c5c);
        background: var(--bg-card, #fdfcfb);
        border-radius: 8px;
        border: 1px solid var(--border-color, #e8e6e3);
      }

      .no-articles-title {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--text-color);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .hero-section {
          grid-template-columns: 1fr;
          gap: 2rem;
        }

        .hero-cover {
          max-width: 100%;
          margin: 0 auto;
        }

        .articles-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 32px;
        }
      }

      @media (max-width: 768px) {
        .issue-container {
          padding: 1.5rem 1.25rem;
        }

        .hero-section {
          padding: 1.5rem;
        }

        .hero-title {
          font-size: 2rem;
        }

        .hero-actions {
          flex-direction: column;
        }

        .hero-button {
          width: 100%;
          justify-content: center;
        }

        .articles-grid {
          grid-template-columns: 1fr;
          gap: 32px;
        }
      }
    </style>
  </head>
  <body>
    <Header />
    <main class="issue-main">
    <div class="issue-container">
      {/* Hero Section */}
      <section class="hero-section">
        <div class="hero-cover">
          {numero.copertina_url ? (
            <img 
              src={numero.copertina_url} 
              alt={`Copertina ${testata} n. ${numero.numero_progressivo}`}
              loading="eager"
            />
          ) : (
            <div style="width: 100%; aspect-ratio: 3/4; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 2rem;">
              <span style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem;">{testata}</span>
              <span style="font-size: 1rem;">n. {numero.numero_progressivo}</span>
            </div>
          )}
        </div>

        <div class="hero-content">
          <span class="hero-badge">{testata}</span>
          
          <h1 class="hero-title">
            {numero.titolo_numero || numero.display_title}
          </h1>

          <div class="hero-meta">
            <div class="hero-meta-item">
              <span class="hero-meta-label">Numero:</span>
              <span>n. {numero.numero_progressivo}</span>
            </div>
            <div class="hero-meta-item">
              <span class="hero-meta-label">Anno:</span>
              <span>{numero.anno_pubblicazione}</span>
            </div>
            {numero.periodo_label && (
              <div class="hero-meta-item">
                <span class="hero-meta-label">Periodo:</span>
                <span>{numero.periodo_label}</span>
              </div>
            )}
          </div>

          {descrizione && (
            <div class="hero-description">
              {descrizione}
            </div>
          )}

          <div class="hero-actions">
            {archiveViewUrl ? (
              <a 
                href={archiveViewUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button"
              >
                <span>ðŸ“–</span>
                <span>Sfoglia Online</span>
              </a>
            ) : (
              <button class="hero-button" disabled>
                <span>ðŸ“–</span>
                <span>Sfoglia Online (non disponibile)</span>
              </button>
            )}

            {pdfUrl ? (
              <a 
                href={pdfUrl} 
                target="_blank" 
                rel="noopener noreferrer"
                class="hero-button secondary"
              >
                <span>ðŸ“¥</span>
                <span>Scarica PDF</span>
              </a>
            ) : (
              <button class="hero-button secondary" disabled>
                <span>ðŸ“¥</span>
                <span>Scarica PDF (non disponibile)</span>
              </button>
            )}
          </div>
        </div>
      </section>

      {/* Articoli: lista uniforme (IT) + English Edition in fondo */}
      <section class="articles-section">
        <div class="articles-header">
          <h2 class="articles-title">Articoli in questo numero</h2>
          <p class="articles-count">
            {articoliIt.length} {articoliIt.length === 1 ? 'articolo' : 'articoli'}
            {articoliEn.length > 0 && ` Â· ${articoliEn.length} in English`}
          </p>
        </div>

        {articoliNumero.length > 0 ? (
          <>
            <div class="articles-grid">
              {articoliIt.map(article => {
                const articleSlug = article.data.slug || article.slug;
                const articleDate = article.data.date instanceof Date ? article.data.date : new Date(article.data.date);
                const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
                const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
                const wpIdStr = String(article.data.wp_id ?? '');
                const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image;
                return (
                  <ArticleCard
                    title={article.data.title}
                    slug={articleSlug}
                    categoriaMenu={categoria_menu ?? undefined}
                    issue={article.data.issue_number}
                    forma={formal}
                    author={article.data.author}
                    date={articleDate}
                    image={articleImage}
                  />
                );
              })}
            </div>

            {articoliEn.length > 0 && (
              <div class="english-edition-section">
                <h2>English Edition</h2>
                <div class="articles-grid">
                  {articoliEn.map(article => {
                    const articleSlug = article.data.slug || article.slug;
                    const articleDate = article.data.date instanceof Date ? article.data.date : new Date(article.data.date);
                    const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
                    const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
                    const wpIdStr = String(article.data.wp_id ?? '');
                    const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image;
                    return (
                      <ArticleCard
                        title={article.data.title}
                        slug={articleSlug}
                        categoriaMenu={categoria_menu ?? undefined}
                        issue={article.data.issue_number}
                        forma={formal}
                        author={article.data.author}
                        date={articleDate}
                        image={articleImage}
                      />
                    );
                  })}
                </div>
              </div>
            )}
          </>
        ) : (
          <div class="no-articles">
            <h3 class="no-articles-title">Nessun articolo trovato</h3>
            <p>Non sono stati trovati articoli associati a questo numero.</p>
          </div>
        )}
      </section>
    </div>
    </main>
    <Footer />
    <IssueNavPill prevSlug={prevSlug} nextSlug={nextSlug} />
  </body>
</html>

