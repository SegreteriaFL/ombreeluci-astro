---
import { getCollection } from 'astro:content';
import Header from '../components/Header.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getMegaclusterForArticle, getLabels } from '../config/taxonomy.js';
import megacluster from '../data/articoli_megacluster.json';

const byId = (megacluster as { byId?: Record<string, { img_copertina_url?: string }> }).byId || {};
const autoriById = (megacluster as { autoriById?: Record<string, unknown> }).autoriById || {};
// Debug: verifica caricamento megacluster in build
console.log('[index.astro] Object.keys(megacluster.byId).length =', Object.keys(byId).length);
console.log('[index.astro] Object.keys(megacluster.autoriById).length =', Object.keys(autoriById).length);

// Ottieni tutti gli articoli con gestione errori
let allArticles = [];
let errorMessage = null;
let debugInfo = null;

try {
  console.log('[index.astro] Inizio caricamento articoli...');
  allArticles = await getCollection('blog');
  console.log(`[index.astro] Articoli caricati: ${allArticles.length}`);
  
  // Valida che gli articoli abbiano i campi necessari
  const invalidArticles = allArticles.filter(article => {
    try {
      // Verifica campi obbligatori
      if (!article.data.title) return true;
      if (!article.data.date) return true;
      if (!article.data.author) return true;
      return false;
    } catch (e) {
      return true;
    }
  });
  
  if (invalidArticles.length > 0) {
    console.warn(`[index.astro] Trovati ${invalidArticles.length} articoli con dati mancanti`);
    debugInfo = `Articoli con dati mancanti: ${invalidArticles.length}`;
  }
} catch (error) {
  errorMessage = `Errore caricamento articoli: ${error.message}`;
  console.error('[index.astro] Errore getCollection:', error);
  console.error('[index.astro] Stack:', error.stack);
}

// Ordina tutti gli articoli per data (più recenti prima)
let sortedArticles = [];
let currentPage = 1;
const itemsPerPage = 20;

// Leggi parametro pagina da query string
if (Astro.url.searchParams.has('page')) {
  const pageParam = parseInt(Astro.url.searchParams.get('page') || '1');
  if (pageParam > 0) {
    currentPage = pageParam;
  }
}

if (allArticles.length > 0) {
  try {
    sortedArticles = allArticles
      .filter(article => {
        // Filtra articoli con date valide
        try {
          return article.data.date instanceof Date && !isNaN(article.data.date.getTime());
        } catch (e) {
          console.warn(`[index.astro] Articolo con data non valida: ${article.id}`);
          return false;
        }
      })
      .sort((a, b) => {
        try {
          return b.data.date.getTime() - a.data.date.getTime();
        } catch (e) {
          console.warn(`[index.astro] Errore ordinamento per: ${a.id} o ${b.id}`);
          return 0;
        }
      });
    console.log(`[index.astro] Articoli ordinati: ${sortedArticles.length}`);
  } catch (e) {
    console.error('[index.astro] Errore durante ordinamento:', e);
    errorMessage = `Errore durante ordinamento articoli: ${e.message}`;
  }
}

// Calcola paginazione
const totalPages = Math.max(1, Math.ceil(sortedArticles.length / itemsPerPage));
const startIndex = (currentPage - 1) * itemsPerPage;
const endIndex = startIndex + itemsPerPage;
const paginatedArticles = sortedArticles.slice(startIndex, endIndex);

// Assicurati che currentPage sia valido
if (currentPage > totalPages) {
  currentPage = totalPages;
}
if (currentPage < 1) {
  currentPage = 1;
}

console.log(`[index.astro] Paginazione: pagina ${currentPage} di ${totalPages}, articoli ${paginatedArticles.length} su ${sortedArticles.length}`);
console.log(`[index.astro] Debug paginazione: currentPage=${currentPage}, totalPages=${totalPages}, canGoNext=${currentPage < totalPages}`);
console.log(`[index.astro] URL corrente: ${Astro.url.href}`);

// Funzione per formattare la data in italiano
function formatDateItalian(date: Date): string {
  return new Intl.DateTimeFormat('it-IT', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Archivio Ombre e Luci</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
    <style>
      body {
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
        line-height: 1.75;
      }
      h1 {
        color: #1a1a1a;
        border-bottom: 2px solid #ff1053;
        padding-bottom: 0.5rem;
        font-weight: 800;
        letter-spacing: -0.02em;
      }
      .stats {
        background: transparent;
        padding: 1rem 0;
        margin: 2rem 0;
        border-bottom: 1px solid #e5e5e5;
      }
      .articles-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 32px;
        margin: 2rem 0;
      }
      @media (max-width: 768px) {
        body { padding: 0.75rem; max-width: 100vw; overflow-x: hidden; }
        h1 { font-size: 1.8rem; }
        .articles-grid {
          grid-template-columns: 1fr !important;
          gap: 24px;
        }
        .articles-grid > * { min-width: 0; }
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 1rem;
        margin: 2rem 0;
        padding: 1rem;
      }
      .pagination-button {
        padding: 0.75rem 1.5rem;
        background: #ff1053;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        text-transform: none;
        transition: all 0.3s ease-in-out;
        display: inline-block;
        cursor: pointer;
        font-family: 'Raleway', system-ui, -apple-system, sans-serif;
      }
      .pagination-button:hover {
        background: #e00e4a;
        transform: translateY(-1px);
      }
      .pagination-button:disabled,
      .pagination-button.disabled {
        background: #ccc;
        cursor: not-allowed;
        pointer-events: none;
        color: #666;
      }
      .pagination-info {
        color: #666;
        font-size: 0.95rem;
      }
      .pagination-info small {
        display: block;
        margin-top: 0.5rem;
      }
    </style>
    <script>
      // Gestione paginazione con reload forzato
      document.addEventListener('DOMContentLoaded', function() {
        const paginationLinks = document.querySelectorAll('.pagination a[data-page]');
        paginationLinks.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            const url = new URL(window.location.href);
            url.searchParams.set('page', page);
            console.log('Navigazione a:', url.toString());
            window.location.href = url.toString();
          });
        });
      });
    </script>
  </head>
  <body>
    <Header />
    
    <div class="index-main" style="max-width: min(1200px, 100%); margin: 0 auto; padding: 0 2rem; overflow-x: hidden;">
      <h1>Archivio Ombre e Luci</h1>
    
    {errorMessage ? (
      <div style="background: #fee; padding: 1rem; border-radius: 8px; color: #c00; margin: 2rem 0;">
        <strong>❌ Errore:</strong> {errorMessage}
        {debugInfo && (
          <div style="margin-top: 0.5rem; font-size: 0.9rem;">
            <strong>Info debug:</strong> {debugInfo}
          </div>
        )}
        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #fcc;">
          <p><strong>Suggerimenti:</strong></p>
          <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
            <li>Controlla la console del server per dettagli</li>
            <li>Verifica che tutti gli articoli abbiano i campi obbligatori (title, date, author)</li>
            <li>Prova ad accedere a <a href="/test-status" style="color: #0066cc;">/test-status</a> per vedere lo stato</li>
          </ul>
        </div>
      </div>
    ) : (
      <>
        <div class="stats">
          <strong>Totale articoli: {sortedArticles.length}</strong> | 
          Pagina {currentPage} di {totalPages}
          {currentPage < totalPages && (
            <span style="margin-left: 1rem; color: #0066cc;">
              (Prossima: <a href={`/?page=${currentPage + 1}`} style="color: #0066cc; text-decoration: underline;">pagina {currentPage + 1}</a>)
            </span>
          )}
        </div>

        {paginatedArticles.length > 0 ? (
          <>
            <div class="articles-grid" style="align-items: start;">
              {paginatedArticles.map((article, idx) => {
                try {
                  const articleSlug = article.data.slug || article.id.replace(/\.md$/, '').replace(/^.*\//, '');
                  const articleDate = article.data.date instanceof Date ? article.data.date : new Date(article.data.date);
                  const { categoria_menu } = getMegaclusterForArticle(article.data.wp_id);
                  const { formal } = getLabels(article.data.tags ?? [], article.data.wp_id);
                  const wpIdStr = String(article.data.wp_id ?? '');
                  const articleImage = byId[wpIdStr]?.img_copertina_url || article.data.image || (article.data as { copertina_url?: string }).copertina_url;
                  return (
                    <div>
                      <ArticleCard
                        title={article.data.title || 'Titolo mancante'}
                        slug={articleSlug}
                        categoriaMenu={categoria_menu ?? undefined}
                        issue={article.data.issue_number}
                        forma={formal}
                        author={article.data.author || 'Autore sconosciuto'}
                        date={articleDate}
                        image={articleImage}
                      />
                    </div>
                  );
                } catch (e) {
                  console.error(`[index.astro] Errore rendering articolo ${article.id}:`, e);
                  return null;
                }
              })}
            </div>
            
            <div class="pagination">
              {currentPage <= 1 ? (
                <span class="pagination-button disabled">
                  ← Indietro
                </span>
              ) : (
                <a 
                  href={`/?page=${currentPage - 1}`}
                  class="pagination-button"
                  data-page={currentPage - 1}
                >
                  ← Indietro
                </a>
              )}
              <span class="pagination-info">
                Pagina {currentPage} di {totalPages} | Articoli: {paginatedArticles.length} | Totale: {sortedArticles.length}
                <br />
                <small style="color: #666; font-size: 0.85rem;">
                  {currentPage < totalPages ? (
                    <>Link test: <a href={`/?page=${currentPage + 1}`} style="color: #0066cc;" data-page={currentPage + 1}>/?page={currentPage + 1}</a></>
                  ) : (
                    <>Ultima pagina raggiunta</>
                  )}
                </small>
              </span>
              {currentPage >= totalPages ? (
                <span class="pagination-button disabled" title={`Sei già all'ultima pagina (${totalPages})`}>
                  Avanti →
                </span>
              ) : (
                <a 
                  href={`/?page=${currentPage + 1}`}
                  class="pagination-button"
                  title={`Vai alla pagina ${currentPage + 1}`}
                  data-page={currentPage + 1}
                >
                  Avanti →
                </a>
              )}
            </div>
          </>
        ) : (
          <div style="padding: 2rem; text-align: center; color: #666;">
            Nessun articolo trovato o errore nel caricamento.
          </div>
        )}
      </>
    )}
    </div>
  </body>
</html>

