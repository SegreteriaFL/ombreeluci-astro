---
import { ViewTransitions } from 'astro:transitions';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import SupportHero from '../components/support/SupportHero.astro';
import CopyField from '../components/support/CopyField.astro';
import FaqAccordion from '../components/support/FaqAccordion.astro';
import '../styles/global.css';
import {
  INTESTATARIO,
  IBAN_RAW,
  IBAN_DISPLAY,
  CCP,
  CCP_DISPLAY,
  CF,
  RUNTS,
  EMAIL,
  ABBONAMENTO_ANNO,
  ABBONAMENTO_MESE,
  NUMERI_ANNO,
} from '../config/support.ts';

const heroImages = ['/images/dona1.webp', '/images/dona2.webp', '/images/dona3.webp', '/images/dona4.webp', '/images/dona7.webp'];
---

<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sostieni Ombre e Luci – Donazione, 5×1000, Abbonamento</title>
    <meta name="description" content="Sostieni Ombre e Luci con una donazione. Senza sponsor: la rivista vive grazie a chi la legge." />
    <ViewTransitions />
  </head>
  <body class="support-page">
    <Header />

    <div id="support-toast" class="support-toast" role="status" aria-live="polite" aria-hidden="true">
      <span class="support-toast-icon">✓</span>
      <span class="support-toast-text">Copiato</span>
    </div>

    <a href="#support-box" class="support-sticky-cta" id="support-sticky-cta" aria-label="Vai a dona">Dona ora</a>

    <SupportHero imageSrcs={heroImages} imageAlt="Ombre e Luci">
      <div class="container support-container">
        <section class="support-section support-altri-modi" id="altri-modi" aria-labelledby="altri-modi-label">
          <span id="altri-modi-label" class="support-section-label">Altri modi per sostenerci</span>
          <div class="support-cards">
            <div class="support-card" id="bonifico">
              <span class="support-card-label">Bonifico</span>
              <p class="support-card-intestatario">{INTESTATARIO}</p>
              <CopyField label="IBAN" value={IBAN_DISPLAY} copyValue={IBAN_RAW} trackId="support_copy_iban" />
              <CopyField label="CCP" value={CCP_DISPLAY} copyValue={CCP} trackId="support_copy_ccp" />
              <p class="support-card-hint">Puoi impostare un bonifico ricorrente dalla tua banca.</p>
            </div>
            <div class="support-card" id="cinquemille">
              <span class="support-card-label">5×1000</span>
              <p class="support-card-hint">Ti costa zero. Firma nel riquadro «Sostegno del volontariato» e inserisci il codice fiscale.</p>
              <CopyField label="Codice Fiscale" value={CF} trackId="support_copy_cf" />
              <p class="support-card-runts">RUNTS {RUNTS}</p>
            </div>
            <div class="support-card" id="abbonamento">
              <span class="support-card-label">Abbonamento</span>
              <p class="support-card-abbonamento">{NUMERI_ANNO} numeri l'anno · {ABBONAMENTO_ANNO}€/anno oppure {ABBONAMENTO_MESE}€/mese</p>
              <a href={`mailto:${EMAIL}?subject=Abbonamento Ombre e Luci`} class="support-card-link">Scopri abbonamento</a>
            </div>
          </div>
        </section>

        <section class="support-section support-impatto" aria-labelledby="impatto-label">
          <span id="impatto-label" class="support-section-label">Cosa rendi possibile</span>
          <ul class="support-impatto-list">
            <li>Pubblicazione e lavoro editoriale</li>
            <li>Sito e archivio</li>
            <li>Stampa e spedizione dei numeri</li>
            <li>Progetti e attività collegati a Fede e Luce</li>
          </ul>
          <p class="support-impatto-chiudi">Ogni euro va dove serve.</p>
        </section>

        <section class="support-section support-faq" aria-labelledby="faq-label">
          <span id="faq-label" class="support-section-label">Domande frequenti</span>
          <FaqAccordion />
        </section>
      </div>
    </SupportHero>
    <Footer />
  </body>
</html>

<script>
  (function () {
    function emit(name, detail) {
      try {
        window.dispatchEvent(new CustomEvent(name, { detail: detail || {} }));
        if (typeof window.dataLayer !== 'undefined') {
          window.dataLayer.push({ event: name, ...(detail || {}) });
        }
      } catch (_) {}
    }

    function showToast() {
      const toast = document.getElementById('support-toast');
      if (!toast) return;
      toast.setAttribute('aria-hidden', 'false');
      toast.classList.add('support-toast-visible');
      clearTimeout(window._supportToastTimeout);
      window._supportToastTimeout = setTimeout(function () {
        toast.classList.remove('support-toast-visible');
        toast.setAttribute('aria-hidden', 'true');
      }, 2000);
    }

    document.querySelectorAll('.copy-field-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        const value = btn.getAttribute('data-copy-value');
        const trackId = btn.getAttribute('data-track-id');
        if (!value) return;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(value).then(function () {
            showToast();
            if (trackId) emit(trackId, { value: value });
          });
        }
        var orig = btn.textContent;
        btn.textContent = 'Copiato';
        setTimeout(function () { btn.textContent = orig; }, 2000);
      });
    });

    document.querySelectorAll('a[href="#support-box"]').forEach(function (a) {
      a.addEventListener('click', function (e) {
        e.preventDefault();
        var el = document.getElementById('support-box');
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    document.querySelectorAll('a[href="#bonifico"]').forEach(function (a) {
      a.addEventListener('click', function (e) {
        e.preventDefault();
        var el = document.getElementById('bonifico');
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    var stickyCta = document.getElementById('support-sticky-cta');
    if (stickyCta) {
      var supportBox = document.getElementById('support-box');
      function onScroll() {
        if (!supportBox) return;
        var boxTop = supportBox.getBoundingClientRect().top;
        stickyCta.classList.toggle('support-sticky-cta-visible', boxTop > window.innerHeight * 0.5);
      }
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    }

    var bonificoEl = document.getElementById('bonifico');
    if (bonificoEl && typeof IntersectionObserver !== 'undefined') {
      var bonificoObs = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          if (entry.isIntersecting) {
            emit('support_scroll_bonifico', { visible: true });
            bonificoObs.disconnect();
          }
        });
      }, { rootMargin: '0px', threshold: 0.3 });
      bonificoObs.observe(bonificoEl);
    }
  })();
</script>

<style>
  /* Footer in flow quando finisce la sezione (niente fixed) */
  :global(.support-page) :global(.footer-reveal-wrap) :global(.reveal-spacer) {
    height: 0 !important;
  }
  :global(.support-page) :global(.site-footer) {
    position: static !important;
    left: auto !important;
    bottom: auto !important;
  }

  .support-page {
    padding-bottom: 2rem;
  }

  .support-container {
    padding-top: 3rem;
    padding-bottom: 3rem;
  }

  .support-toast {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(0.5rem);
    background: var(--text-color);
    color: #fff;
    padding: 0.6rem 1.25rem;
    border-radius: 10px;
    font-size: 0.9375rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s, transform 0.25s, visibility 0.25s;
    z-index: 9999;
  }
  .support-toast.support-toast-visible {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }
  .support-toast-icon {
    color: #86efac;
  }

  .support-sticky-cta {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1rem;
    background: var(--accent-color);
    color: #fff;
    text-align: center;
    font-weight: 700;
    text-decoration: none;
    z-index: 100;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
  }
  .support-sticky-cta.support-sticky-cta-visible {
    transform: translateY(0);
  }
  @media (min-width: 901px) {
    .support-sticky-cta { display: none !important; }
  }
  @media (max-width: 900px) {
    .support-sticky-cta { display: block; }
  }

  .support-section {
    margin-bottom: 3rem;
  }
  .support-section-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-secondary);
    margin-bottom: 1.25rem;
  }
  .support-altri-modi {
    margin-top: 0;
  }
  .support-cards {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }
  .support-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
  }
  .support-card-label {
    font-size: 0.8125rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: var(--text-secondary);
    display: block;
    margin-bottom: 0.5rem;
  }
  .support-card-intestatario,
  .support-card-abbonamento {
    font-size: 0.9375rem;
    color: var(--text-color);
    margin: 0;
  }
  .support-card-hint {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin: 0.75rem 0 0 0;
    line-height: 1.5;
  }
  .support-card-runts {
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin: 0.5rem 0 0 0;
  }
  .support-card-link {
    display: inline-block;
    margin-top: 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--accent-color);
  }
  .support-card-link:hover {
    text-decoration: underline;
  }

  .support-impatto-list {
    font-size: 1rem;
    color: var(--text-color);
    margin: 0.5rem 0 0 0;
    padding-left: 1.25rem;
    line-height: 1.7;
  }
  .support-impatto-list li {
    margin-bottom: 0.35rem;
  }
  .support-impatto-chiudi {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    margin: 1.25rem 0 0 0;
  }

  .support-faq .support-section-label {
    margin-bottom: 1rem;
  }

  @media (max-width: 900px) {
    .support-container {
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
  }
</style>
